###############################################################################
#                               IMPORTANT NOTICE                                #
###############################################################################
#                                                                             #
# This file was generated by Terraform.                                       #
# Please do not edit this file directly.                                      #
# Instead, edit the vault_secret module in terraform code and re-run it       #
# to update this file.                                                        #
#                                                                             #
###############################################################################

name: 'Get Vault Secrets'
description: 'Retrieve secrets from HashiCorp Vault'

inputs:
  vault_addr:
    description: 'Vault server address'
    required: true
  droplet_ip:
    description: 'Droplet IP address'
    required: true
  ssh_private_key:
    description: 'SSH private key for server access'
    required: true

outputs:
  app_domain:
    description: 'App Domain'
    value: ${{ steps.vault.outputs.app_domain }}
  app_name:
    description: 'App Name'
    value: ${{ steps.vault.outputs.app_name }}
  app_support_email:
    description: 'App Support Email'
    value: ${{ steps.vault.outputs.app_support_email }}
  dockerhub_password:
    description: 'Dockerhub Password'
    value: ${{ steps.vault.outputs.dockerhub_password }}
  dockerhub_username:
    description: 'Dockerhub Username'
    value: ${{ steps.vault.outputs.dockerhub_username }}
  domains:
    description: 'Domains'
    value: ${{ steps.vault.outputs.domains }}
  droplet_ip:
    description: 'Droplet Ip'
    value: ${{ steps.vault.outputs.droplet_ip }}
  frontend_bucket_endpoint:
    description: 'Frontend Bucket Endpoint'
    value: ${{ steps.vault.outputs.frontend_bucket_endpoint }}
  frontend_bucket_name:
    description: 'Frontend Bucket Name'
    value: ${{ steps.vault.outputs.frontend_bucket_name }}
  github_username:
    description: 'Github Username'
    value: ${{ steps.vault.outputs.github_username }}
  mailer_from_address:
    description: 'Mailer From Address'
    value: ${{ steps.vault.outputs.mailer_from_address }}
  mailer_from_name:
    description: 'Mailer From Name'
    value: ${{ steps.vault.outputs.mailer_from_name }}
  mongodb_database:
    description: 'Mongodb Database'
    value: ${{ steps.vault.outputs.mongodb_database }}
  mongodb_host:
    description: 'Mongodb Host'
    value: ${{ steps.vault.outputs.mongodb_host }}
  mongodb_password:
    description: 'Mongodb Password'
    value: ${{ steps.vault.outputs.mongodb_password }}
  mongodb_user:
    description: 'Mongodb User'
    value: ${{ steps.vault.outputs.mongodb_user }}
  postmark_api_key:
    description: 'Postmark Api Key'
    value: ${{ steps.vault.outputs.postmark_api_key }}
  repo_access_token:
    description: 'Repo Access Token'
    value: ${{ steps.vault.outputs.repo_access_token }}
  spaces_access_id:
    description: 'Spaces Access Id'
    value: ${{ steps.vault.outputs.spaces_access_id }}
  spaces_region:
    description: 'Spaces Region'
    value: ${{ steps.vault.outputs.spaces_region }}
  spaces_secret_key:
    description: 'Spaces Secret Key'
    value: ${{ steps.vault.outputs.spaces_secret_key }}
  ssh_private_key_path:
    description: 'Ssh Private Key Path'
    value: ${{ steps.vault.outputs.ssh_private_key_path }}

runs:
  using: "composite"
  steps:
    - name: Generate Action Outputs
      id: vault
      shell: bash
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ inputs.ssh_private_key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ inputs.droplet_ip }} >> ~/.ssh/known_hosts

        # Get vault data using the vault CLI on the remote server via SSH.
        VAULT_DATA=$(ssh -i ~/.ssh/id_rsa deployuser@${{ inputs.droplet_ip }} '
          ROOT_TOKEN=$(jq -r .root_token < /home/deployuser/.vault/vault_credentials.txt)
          VAULT_CONTAINER=$(docker ps -q -f name=vault)
          docker exec $VAULT_CONTAINER sh -c "VAULT_TOKEN=$ROOT_TOKEN vault kv get -format=json secret/config" | jq -r ".data.data"
        ')

        if echo "$VAULT_DATA" | jq -e '.' >/dev/null 2>&1; then
          # Validate JSON format
          echo "$VAULT_DATA" > /dev/null
        else
          echo "Error: Invalid JSON received" >&2
          echo "$VAULT_DATA" >&2
          exit 1
        fi

        # Clean up the SSH key
        rm -f ~/.ssh/id_rsa

        # Save the raw data for debugging
        echo "raw_vault_data<<EOF" >> "$GITHUB_OUTPUT"
        echo "$VAULT_DATA" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"

        # Export each key-value pair from the JSON.
        while IFS="=" read -r key value; do
          # Trim quotes from the value if present
          value=$(echo "$value" | tr -d '"')
          echo "$key=$value" >> "$GITHUB_OUTPUT"
        done < <(echo "$VAULT_DATA" | jq -r 'to_entries | .[] | "\(.key)=\(.value|tostring)"')



